<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>התשלום התקבל</title>
  <style>
    body{direction:rtl;background:#f5f7fb;font-family:system-ui,-apple-system,segoe ui,arial,sans-serif;margin:0}
    .card{max-width:740px;margin:80px auto;background:#fff;border-radius:20px;box-shadow:0 15px 50px rgba(0,0,0,.08);padding:40px;text-align:center}
    h1{color:#1e9043;font-size:42px;margin:0 0 10px}
    p{color:#3e556e;margin:8px 0 0}
    .btn{display:inline-block;margin:22px 0 10px;padding:14px 22px;border-radius:12px;
         background:#cfe2ff;color:#1a4480;text-decoration:none;font-weight:700;cursor:not-allowed;opacity:.6}
    .btn.enabled{background:#7eb2ff;color:#0b2d6b;cursor:pointer;opacity:1}
    .note{color:#6b7a90;margin-top:10px}
    .err{margin-top:18px;background:#fee2e2;color:#991b1b;border-radius:12px;padding:14px 16px;line-height:1.5;text-align:right;direction:ltr}
  </style>
</head>
<body>
  <div class="card">
    <h1>התשלום התקבל</h1>
    <p id="msg">מעבד את התשלום…</p>

    <a id="viewBtn" class="btn" href="javascript:void(0)" aria-disabled="true">לצפייה באישור יציאה</a>

    <div class="note">.אירוע. ייתכן שהשרת עדיין מעבד את האישור, ייקח יותר מכמה שניות</div>

    <div id="err" class="err" style="display:none"></div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const token = qs.get('token') || '';
    const viewBtn = document.getElementById('viewBtn');
    const msg = document.getElementById('msg');
    const errBox = document.getElementById('err');

    if (!token) {
      msg.textContent = 'חסר מזהה תשלום (token).';
      viewBtn.classList.remove('enabled');
      viewBtn.setAttribute('aria-disabled','true');
    } else {
      poll();
      const tid = setInterval(poll, 3000);

      async function poll() {
        try {
          const res = await fetch('/.netlify/functions/fetch-slip?token=' + encodeURIComponent(token), {
            headers: { 'accept': 'application/json' }
          });
          const text = await res.text();
          let data = null; try { data = JSON.parse(text); } catch {}

          if (!res.ok) {
            throw new Error(data?.error || ('Unexpected response from server: ' + text.slice(0,160)));
          }

          if (data.status === 'pending') {
            msg.textContent = 'מעבד את התשלום…';
            return; // keep polling
          }

          if (data.status === 'ready' && data.data) {
            clearInterval(tid);
            msg.textContent = 'התשלום נקלט. אפשר לצפות באישור.';
            viewBtn.classList.add('enabled');
            viewBtn.removeAttribute('aria-disabled');

            // Build final confirmation URL with the saved values
            const slip = data.data;
            const params = new URLSearchParams({
              date: slip.date || '',
              release_time: slip.release_time || '',
              student_name: slip.student_name || '',
              class: slip.class || '',
              reason: slip.reason || '',
              email: slip.email || '',
              status: 'אושר',
              frequency: 'חד פעמי',
              exit_time: '00:00',
              return_time: '00:00',
              approved_by: slip.approved_by || ''
            });
            const dest = '/confirmation.html?' + params.toString();

            viewBtn.onclick = () => { location.href = dest; };
          }
        } catch (e) {
          errBox.style.display = 'block';
          errBox.textContent = String(e.message || e);
        }
      }
    }
  </script>
</body>
</html>
