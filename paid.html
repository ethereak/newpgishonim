<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>התשלום התקבל</title>
  <style>
    body{direction:rtl;background:#f5f7fb;font-family:system-ui,-apple-system,segoe ui,arial,sans-serif;margin:0}
    .card{max-width:740px;margin:80px auto;background:#fff;border-radius:20px;box-shadow:0 15px 50px rgba(0,0,0,.08);padding:40px;text-align:center}
    h1{color:#1e9043;font-size:42px;margin:0 0 10px}
    p{color:#3e556e;margin:8px 0 0}
    .btn{display:inline-block;margin:22px 0 10px;padding:14px 22px;border-radius:12px;
         background:#cfe2ff;color:#1a4480;text-decoration:none;font-weight:700;cursor:not-allowed;opacity:.6}
    .btn.enabled{background:#7eb2ff;color:#0b2d6b;cursor:pointer;opacity:1}
    .note{color:#6b7a90;margin-top:10px}
    .err{margin-top:18px;background:#fee2e2;color:#991b1b;border-radius:12px;padding:14px 16px;line-height:1.5;text-align:right;direction:ltr}
  </style>
</head>
<body>
  <div class="card">
    <h1>התשלום התקבל</h1>
    <p id="msg">מעבד את התשלום…</p>

    <a id="viewBtn" class="btn" href="javascript:void(0)" aria-disabled="true">לצפייה באישור יציאה</a>

    <div class="note">.אירוע. ייתכן שהשרת עדיין מעבד את האישור, ייקח יותר מכמה שניות</div>

    <div id="err" class="err" style="display:none"></div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const token = qs.get('token') || '';
    const viewBtn = document.getElementById('viewBtn');
    const msg = document.getElementById('msg');
    const errBox = document.getElementById('err');

    if (!token) {
      msg.textContent = 'חסר מזהה תשלום (token).';
      viewBtn.classList.remove('enabled');
      viewBtn.setAttribute('aria-disabled','true');
    } else {
      poll();
      const tid = setInterval(poll, 3000);

      async function poll() {
        try {
          const res = await fetch('/.netlify/functions/fetch-slip?token=' + encodeURIComponent(token), {
            headers: { 'accept': 'application/json' }
          });
          const text = await res.text();
          let data = null; try { data = JSON.parse(text); } catch {}

          if (!res.ok) {
            throw new Error(data?.error || ('Unexpected response from server: ' + text.slice(0,160)));
          }

          if (data.status === 'pending') {
            msg.textContent = 'מעבד את התשלום…';
            return; // keep polling
          }

          if (data.status === 'ready' && data.data) {
            clearInterval(tid);
            msg.textContent = 'התשלום נקלט. אפשר לצפות באישור.';
            viewBtn.classList.add('enabled');
            viewBtn.removeAttribute('aria-disabled');

            // Build final confirmation URL with the saved values
            const slip = data.data;
            const params = new URLSearchParams({
              date: slip.date || '',
              release_time: slip.release_time || '',
              student_name: slip.student_name || '',
              class: slip.class || '',
              reason: slip.reason || '',
              email: slip.email || '',
              status: 'אושר',
              frequency: 'חד פעמי',
              exit_time: '00:00',
              return_time: '00:00',
              approved_by: slip.approved_by || ''
            });
            const dest = '/confirmation.html?' + params.toString();

            viewBtn.onclick = () => { location.href = dest; };
          }
        } catch (e) {
          errBox.style.display = 'block';
          errBox.textContent = String(e.message || e);
        }
      }
    }
  </script>
  <script>
/*
  Paid page debugger:
  - Detects token from ?token=...
  - Adds an overlay with logs + buttons
  - Calls /.netlify/functions/get-slip?token=...&debug=1
  - Shows status, headers, and the first part of the response body
  - Can auto-poll until slip is ready
*/

(() => {
  const FN = '/.netlify/functions/get-slip';
  const qs = new URLSearchParams(location.search);
  const token = qs.get('token') || sessionStorage.getItem('slipToken') || '';
  if (token) sessionStorage.setItem('slipToken', token);

  // ---------- UI ----------
  const pane = document.createElement('div');
  pane.style.cssText = 'position:fixed;left:0;right:0;bottom:0;max-height:45vh;overflow:auto;background:#111;color:#0f0;font:12px/1.5 monospace;padding:10px;border-top:2px solid #0f0;z-index:99999999';
  pane.innerHTML = `
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px">
      <button id="dbg-call">Call get-slip</button>
      <button id="dbg-poll">Start polling</button>
      <button id="dbg-stop" disabled>Stop polling</button>
      <button id="dbg-clear">Clear</button>
      <button id="dbg-hide" style="margin-left:auto">Hide</button>
    </div>
    <pre id="dbg-log" style="white-space:pre-wrap"></pre>
  `;
  document.body.appendChild(pane);
  const logEl = document.getElementById('dbg-log');
  const log = (...a) => {
    const line = a.map(x => {
      if (typeof x === 'string') return x;
      try { return JSON.stringify(x, null, 2); } catch { return String(x); }
    }).join(' ');
    logEl.textContent += `[${new Date().toISOString()}] ${line}\n`;
    console.log('[paid-debug]', ...a);
  };

  const viewBtn = document.getElementById('viewSlipBtn'); // your blue button
  if (viewBtn) {
    viewBtn.addEventListener('click', (e) => {
      e.preventDefault();
      void callOnce();
    });
  }

  // Environment facts
  log('Page:', location.href);
  log('Token:', token || '(none)');
  log('Function:', FN);

  // ---------- helpers ----------
  async function callOnce() {
    if (!token) {
      alert('Missing token in URL.');
      log('ERROR: no token');
      return;
    }
    let res, text;
    try {
      const url = `${FN}?token=${encodeURIComponent(token)}&debug=1`;
      log('Fetching:', url);
      res = await fetch(url, { method: 'GET' });
      const headers = {};
      res.headers.forEach((v, k) => headers[k] = v);
      log('Status:', res.status, res.statusText);
      log('Headers:', headers);
      text = await res.text();
      log('Body (first 500 chars):', text.slice(0, 500) + (text.length > 500 ? '…' : ''));
    } catch (e) {
      alert('שגיאת רשת'); // network error
      log('NETWORK ERROR:', e.message);
      return;
    }

    // Try parse JSON
    let json = null;
    try { json = JSON.parse(text); } catch {}
    if (!json) {
      // You got HTML back (like <!DOCTYPE html>) or something not JSON.
      // This usually means the function path is wrong & a static file is returned.
      log('WARN: Response is not JSON. Is the function name correct?');
      return;
    }

    // Handle statuses from the function
    if (json.status === 'paid' && json.data) {
      log('Slip is READY. Data:', json.data);
      // TODO: generate / navigate to your slip with json.data
      // e.g. location.href = '/confirmation.html?' + new URLSearchParams(json.data).toString();
    } else if (json.status === 'pending') {
      log('Slip still pending (202). Keep polling…');
    } else if (json.error) {
      log('FUNCTION ERROR:', json.error, json.detail || '');
      alert('שגיאה בתהליך התשלום');
    } else {
      log('Unknown JSON shape:', json);
    }
  }

  // Polling controls
  let polling = null;
  const btnCall = document.getElementById('dbg-call');
  const btnPoll = document.getElementById('dbg-poll');
  const btnStop = document.getElementById('dbg-stop');
  const btnClear = document.getElementById('dbg-clear');
  const btnHide = document.getElementById('dbg-hide');

  btnCall.onclick = () => void callOnce();
  btnPoll.onclick = () => {
    if (polling) return;
    log('Starting polling every 3s…');
    btnPoll.disabled = true;
    btnStop.disabled = false;
    polling = setInterval(callOnce, 3000);
    void callOnce();
  };
  btnStop.onclick = () => {
    if (polling) {
      clearInterval(polling);
      polling = null;
      btnPoll.disabled = false;
      btnStop.disabled = true;
      log('Stopped polling.');
    }
  };
  btnClear.onclick = () => (logEl.textContent = '');
  btnHide.onclick = () => pane.remove();
})();
</script>

</body>
</html>
