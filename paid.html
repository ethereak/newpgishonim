<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>תשלום בוצע בהצלחה</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/general-pages.css">
  <style>
    body { font-family: sans-serif; background:#0b0f12; color:#fff; }
    .box { max-width: 560px; margin: 8vh auto; background:#12171c; padding:24px; border-radius:12px }
    .btn { display:inline-block; margin-top:16px; padding:12px 18px; background:#2e7efb; color:#fff; border-radius:8px; text-decoration:none }
  </style>
</head>
<body>
  <div class="box">
    <h2>התשלום התקבל ✅</h2>
    <p>לחץ על הכפתור כדי לצפות באישור היציאה.</p>
    <a id="go" class="btn" href="#" style="display:none">לצפייה באישור יציאה</a>
    <p id="wait">בודק את מצב התשלום…</p>
  </div>

  <script>
    (async function () {
      const token = new URL(location.href).searchParams.get("token");
      if (!token) { document.getElementById("wait").textContent = "Missing token"; return; }
      try {
        const r = await fetch(`/.netlify/functions/pass?token=${encodeURIComponent(token)}`);
        if (!r.ok) throw new Error("Not paid yet");
        const { form } = await r.json();

        // Build the same query your confirmation page expects
        const params = new URLSearchParams({
          date: form.date,
          release_time: form.release_time,
          student_name: form.student_name,
          class: form.class,
          reason: form.reason,
          approved_by: form.approved_by,
          status: "אושר",
          frequency: "חד פעמי",
          exit_time: "00:00",
          return_time: "00:00"
        });

        const href = `/confirmation.html?${params.toString()}`;
        const btn = document.getElementById("go");
        btn.href = href;
        btn.style.display = "inline-block";
        document.getElementById("wait").style.display = "none";
      } catch (e) {
        document.getElementById("wait").textContent = "עדיין לא מאושר. רענן בעוד כמה שניות.";
      }
    })();
  </script>
</body>
</html>
