<script>
(async function () {
  const btn = document.getElementById('view-slip'); // your blue button
  const statusEl = document.getElementById('status'); // “מעבד את התשלום…”
  const token = new URL(location.href).searchParams.get('token');

  async function check() {
    const res = await fetch('/.netlify/functions/paid?token=' + encodeURIComponent(token));
    const json = await res.json();
    if (json.status === 'paid') {
      // build the slip URL with the saved fields
      const p = new URLSearchParams({
        student_name: json.data.student_name,
        class: json.data.class,
        date: json.data.date,
        release_time: json.data.release_time,
        reason: json.data.reason,
        approved_by: json.data.approved_by
      });
      btn.disabled = false;
      statusEl.textContent = 'התשלום התקבל';
      btn.onclick = () => location.href = '/confirmation.html?' + p.toString();
    } else {
      btn.disabled = true;
      setTimeout(check, 2500); // keep polling until webhook writes the record
    }
  }
  check();
})();
</script>
